dist: goreleaser
project_name: customer-managed-deployment-agent
checksum:
  name_template: 'checksums.txt'
archives:
  - id: archive
    name_template: >-
      {{- .Binary }}-
      {{- .Tag }}-
      {{- .Os }}-
      {{- if eq .Arch "amd64" }}x64
      {{- else }}{{ .Arch }}{{ end }}
    format_overrides:
      - goos: windows
        format: zip
    files:
      # OS specific scripts, not compiled
      - src: bin/{{ .Os }}/*
        dst: '.'
        strip_parent: true
      # binaries
      - src: bin/{{ .Os }}-{{ .Arch }}/*
        dst: '.'
        strip_parent: true
builds:
  - id: customer-managed-deployment-agent
    binary: customer-managed-deployment-agent
    dir: ./pulumi-service/cmd/customer-managed-deployment-agent
    goarch:
      - amd64
      - arm64
    goos:
      - darwin
      - linux
    ldflags:
      - -s
      - -w
      - -X github.com/pulumi/pulumi-service/cmd/customer-managed-deployment-agent/version.Version={{.Tag}}
signs:
  - cmd: cosign
    stdin: '{{ .Env.COSIGN_PASSWORD }}'
    args:
      - "sign-blob"
      - "--key=cosign.key"
      - "--output-signature=${signature}"
      - "${artifact}"
      - "--yes" # needed on cosign 2.0.0+
    artifacts: all

